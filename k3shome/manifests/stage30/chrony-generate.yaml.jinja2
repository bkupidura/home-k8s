---
apiVersion: v1
kind: Service
metadata:
  name: chrony
  namespace: home-infra
  labels:
    app.kubernetes.io/name: chrony
spec:
  type: LoadBalancer
  loadBalancerIP: "{{ manifest.vips[5].ip }}"
  publishNotReadyAddresses: false
  ports:
    - name: chrony
      port: 123
      protocol: UDP
  selector:
    app.kubernetes.io/name: chrony

---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: chrony
  namespace: home-infra
  labels:
    app.kubernetes.io/name: chrony
spec:
  updateStrategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app.kubernetes.io/name: chrony
  template:
    metadata:
      labels:
        app.kubernetes.io/name: chrony
    spec:
      containers:
        - name: chrony
          image: {{ manifest.versions.chrony.repository }}:{{ manifest.versions.chrony.tag }}
          imagePullPolicy: Always
          ports:
            - name: chrony
              containerPort: 123
              protocol: UDP
          env:
            - name: TZ
              value: {{ manifest.timezone }}
            - name: ALLOW_CIDR
              value: 0.0.0.0/0
            - name: NTP_SERVER
              value: {{ global.ntp_servers[0] }}
          securityContext:
            capabilities:
              add: ["SYS_TIME"]
          readinessProbe:
            exec:
              command:
                - chronyc
                - tracking
            initialDelaySeconds: 30
            periodSeconds: 60
            timeoutSeconds: 5
          livenessProbe:
            exec:
              command:
              - chronyc
              - tracking
            initialDelaySeconds: 30
            periodSeconds: 60
            timeoutSeconds: 5
          volumeMounts:
            - name: tz-config
              mountPath: /etc/localtime
              readOnly: true
            - name: tzdata-config
              mountPath: /etc/timezone
              readOnly: true
      volumes:
        - name: tz-config
          hostPath:
            path: /etc/localtime
        - name: tzdata-config
          hostPath:
            path: /etc/timezone
